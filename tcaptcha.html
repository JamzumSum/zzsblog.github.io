<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Looking into TCaptcha</title><meta name="description" content="What does TCaptcha detect and collect?"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://zzsblog.top/tcaptcha.html"><link rel="amphtml" href="https://zzsblog.top/amp/tcaptcha.html"><link rel="alternate" type="application/atom+xml" href="https://zzsblog.top/feed.xml"><link rel="alternate" type="application/json" href="https://zzsblog.top/feed.json"><meta property="og:title" content="TCaptcha 有哪些检测机制？"><meta property="og:image" content="https://zzsblog.top/media/posts/8/download1"><meta property="og:site_name" content="鸽园"><meta property="og:description" content="What does TCaptcha detect and collect?"><meta property="og:url" content="https://zzsblog.top/tcaptcha.html"><meta property="og:type" content="article"><link rel="shortcut icon" href="https://zzsblog.top/media/website/favicon.png" type="image/png"><link rel="stylesheet" href="https://zzsblog.top/assets/css/style.css?v=ebde456a0982dc3b4cf9161f1fc0c160"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://zzsblog.top/tcaptcha.html"},"headline":"TCaptcha 有哪些检测机制？","datePublished":"2021-08-18T20:50","dateModified":"2022-08-01T20:22","image":{"@type":"ImageObject","url":"https://zzsblog.top/media/posts/8/download1","height":false,"width":false},"description":"What does TCaptcha detect and collect?","author":{"@type":"Person","name":"JamzumSum","url":"https://zzsblog.top/author/jamzumsum/"},"publisher":{"@type":"Organization","name":"JamzumSum","logo":{"@type":"ImageObject","url":"https://zzsblog.top/media/website/favicon-2.png","height":480,"width":480}}}</script><script>window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      processEscapes: true,
    }
  }</script><script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script><link href="https://cdn.jsdelivr.net/npm/prismjs@v1.x/themes/prism.css" rel="stylesheet"></head><body><script src="https://cdn.jsdelivr.net/npm/prismjs@v1.x/components/prism-core.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@v1.x/plugins/autoloader/prism-autoloader.min.js"></script><div class="container"><header class="header" id="js-header"><a href="https://zzsblog.top/" class="logo"><img src="https://zzsblog.top/media/website/favicon-2.png" alt="鸽园" width="480" height="480"></a><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span></button><ul class="navbar__menu"><li><a href="https://zzsblog.top/" title="Goto Homepage" target="_self">Home</a></li><li class="has-submenu"><a href="https://zzsblog.top/tag/" title="Categories" target="_self" aria-haspopup="true">Categories</a><ul class="navbar__submenu level-2" aria-hidden="true"><li><a href="https://zzsblog.top/tag/coding/" title="Coding" target="_self">Coding</a></li><li><a href="https://zzsblog.top/tag/qzone2tg/" title="Collections of Qzone2TG posts" target="_self">Qzone2TG</a></li></ul></li><li><a href="https://zzsblog.top/about.html" title="About me">About</a></li><li><a href="https://github.com/JamzumSum/zzsblog" title="Goto blog repo on GitHub" target="_blank">GitHub</a></li><li><a href="https://zzsblog.top/merger.html" title="Buy me a cup of coffee☕" target="_self">Donate</a></li></ul></nav></header><main><article class="post wrapper"><header class="hero"><p class="post__meta">Published on <time datetime="2021-08-18T20:50">21/08/18</time></p><h1 class="post__title">TCaptcha 有哪些检测机制？</h1></header><figure class="post__featured-image post__image--wide"><img src="https://zzsblog.top/media/posts/8/download1" loading="eager" height="1278" width="1920" alt="white concrete building near green trees during daytime"><figcaption>Crawler @kevinmartinjose</figcaption></figure><div class="post__entry"><h2 id="前言">前言</h2><p>由于我最近在做<a href="https://github.com/JamzumSum/QQQR" title="a simulation of tencent login HTTP protocol">QQQR</a>的验证码部分, 比如</p><figure class="post__image"><img decoding="async" loading="lazy" src="https://zzsblog.top/media/posts/8/tcapcha-screenshot.png" sizes="(max-width: 1024px) 100vw, 1024px" srcset="https://zzsblog.top/media/posts/8/responsive/tcapcha-screenshot-xs.png 300w, https://zzsblog.top/media/posts/8/responsive/tcapcha-screenshot-sm.png 480w, https://zzsblog.top/media/posts/8/responsive/tcapcha-screenshot-md.png 768w, https://zzsblog.top/media/posts/8/responsive/tcapcha-screenshot-lg.png 1024w" alt="Image description" width="563" height="384"></figure>, 在Qzone2TG的前面一些版本里, 我都是用selenium爬取图像配合模拟拖动来做的, 当然也需要一点点的cv技术.<p></p><p>但上面这种办法虽说理论可行, 但并非真的万无一失. 事实上, 在一开始开发的时候跑通之后, 这个办法就再也没好用过. 等到后来我用selenium抓二维码登录, 乃至<a href="https://github.com/JamzumSum/QQQR" title="a simulation of tencent login HTTP protocol">QQQR</a>的第一个版本能够实现协议二维码登录的时候, 我就更不想用这种不可靠的办法了.</p><p>直到<a href="https://github.com/JamzumSum/QQQR" title="a simulation of tencent login HTTP protocol">QQQR</a>的开发到了<code>2.3.0</code>, 我囿于一种执着重新开始研究验证码的破解之道, 在长达十余天乃至可想见的数十天中仔细研究抓包结果和TCaptcha相关的js代码, 我才终于意识到, 使用selenium这些模拟登录的办法究竟处在一种怎样危险的境地.</p><p>截至目前, 我还没有搞定<code>23003 网络环境异常</code>的问题. 我相信唯一让我露馅的可能就在于验证码检测的时候. 尽管如此, 我仍然发现了很多tx检测浏览器特征的”小动作”.</p><blockquote><p>2022年6月16到17号tx似乎升级了tcaptcha，然而应该只是简化流程，基本的逻辑、采集的信息都没有太大变化。</p></blockquote><h2 id="tdxjs">tdx.js</h2><p>在加载TCapcha的时候, 页面会载入<code>tdx.js</code>. 这整个一个JS就是一个…虚拟机, 用我自己能明白的话来说就是一个指令集+栈+纸带(雾)的组合. 我在这上是个外行, 有的时候不明白加密何至于搞这么大的阵仗. 但不得不承认, js混淆+这种叫做<code>TENCENT_CHAOS_VM</code>的技术的确可以大大阻碍我们这些不守规矩的人(嚣张. 但可惜, tx自己搞了个什么大赛, 这种虚拟机的机制已经参赛的大佬们看透了. 我这种一开始蒙在鼓里的人, 在Github上一搜, 也就明白得差不多了.</p><p>上面所说的, 指令集+栈+纸带的组合其实就完全确定了程序的逻辑. 我的目的也就是在这一团糊糊里找出tx究竟搜集了什么信息进而判断出我不对劲的 :(</p><p>我首先尝试了一些手动反汇编的办法, 给每个命令加输出, 类似编译器. 但, 应该说是受限于我本身的水平, 得到的结果不够准确, 没法交给机器处理, 也就没大用. 不过从另一个角度, 这一步让我真正地深入到了指令运行的内部, 从而为后面的调试打下了基础.</p><h2 id="到底检测了什么">到底检测了什么</h2><p>背景和步骤到此为止, 没有再多说的必要了. 下面就是列出一些检测的条目, 给包括我在内的初出茅庐的人们一点警醒: selenium等等这些模拟手段没那么”真”.</p><h3 id="自动化测试工具">自动化测试工具</h3><p>这一类比较泛用, 是确切的用来检测客户端是否受自动化控制的办法.</p><ul><li>window.callPhantom</li><li>window._phantom</li><li>window.WebPage</li><li>window.fxdriver_id</li><li>window.__fxdriver_unwrapped</li><li>window.domAutomation</li><li>window.ubot</li><li>window.CasperError</li><li>window.casper</li><li>window.patchRequire</li><li>navigator.webdriver</li><li>document.$cdc_asdjflasutopfhvcZLmcfl_</li><li>document.__webdriver_script_fn</li></ul><p>这些属性, 正常应该为<code>undefined</code>. 在使用某些特定工具时, 这些值会被设置, 从而可以直接断定当前访问是受自动化控制的.</p><p>比如<code>window.navigator.webdriver</code>, 使用selenium时该项会设为<code>true</code>; 比如<code>window.document.$cdc_asdjflasutopfhvcZLmcfl_</code>是chromedriver的一项特征, 正常的浏览器并没有这个键.</p><h3 id="环境信息">环境信息</h3><p><code>tdx.js</code>也读取了这些信息, 分析它们可以判断当前客户端处在一个什么样的环境. 虽然没有证据. 但我相信<code>23003</code>的错误应该就在此检出(雾</p><h4 id="documentmozhidden">document.mozHidden</h4><p>似乎是检查标签页是否可见, 在chromium上为<code>undefined</code></p><h4 id="navigator">navigator</h4><ul><li>navigator.userAgent</li><li>navigator.appVersion</li><li>navigator.platform</li><li>navigator.cookieEnabled</li><li>navigator.languages</li><li>navigator.vendor</li><li>navigator.appName</li><li>navigator.plugins</li><li>navigator.getBattery</li></ul><h4 id="document--location">document &amp; location</h4><ul><li>document.charset</li><li>document.cookie</li><li>document.referrer</li><li>document.documentElement.clientWidth</li><li>document.documentElement.clientHeight</li><li>document.getElementById</li><li>location.href</li></ul><h4 id="screen--other-display-properties">screen &amp; other display properties</h4><ul><li>screen.colorDepth</li><li>screen.width</li><li>screen.height</li><li>screen.availHeight</li><li>screen.pixelDepth</li><li>window.innerWidth</li><li>window.innerHeight</li></ul><p>上述这些属性和方法均是被检查的对象. 这些项恐怕也是selenium等工具的优势所在: 它们能和正常浏览器保持一致.</p><p>当然, 对于普通的爬虫来说, 恐怕不会有这么细致的检查, 毕竟通常我们只爬HTML, 这些情形基本是遇不到的. 但毕竟<a href="https://github.com/JamzumSum/QQQR" title="a simulation of tencent login HTTP protocol">QQQR</a>是要直接和验证码作斗争, 其本质不仅仅是爬虫, 使用的工具也是<code>requests</code>+<code>nodejs</code>的基础组合, 因此这些都是要注意的对象.</p><h4 id="操作环境">操作环境</h4><p>Tcaptcha 会尝试在环境中调用 <code>CreateElement</code>, <code>FindElementById</code> 等函数，创建和修改包括 <code>img</code>, <code>iframe</code>等在内的众多元素。目前尚未可知创建这些元素是否关联其他操作，不过这对我们使用的模拟环境也是一个考验。</p><h3 id="用户操作">用户操作</h3><p>人类访问是需要操作的, 而爬虫没这个必要. 因此<code>tdx.js</code>也收集用户的动作. （正常情况下是通过Listener收集的，但当<code>CreateElement</code>不可用的时候会暴露<code>tdc.set_data</code>，允许外部传入模拟的数据）</p><ul><li>客户端类型(手机/PC)</li><li>坐标系(验证码位置, 缩放比)</li><li>拖动拼图时鼠标的时间-坐标关系</li></ul><blockquote><p>未完待续</p></blockquote></div><footer class="post__footer"><div class="post__footer__col"><ul class="post__tag"><li><a href="https://zzsblog.top/tag/coding/">Coding</a></li><li><a href="https://zzsblog.top/tag/python/">Python</a></li><li><a href="https://zzsblog.top/tag/qzone2tg/">Qzone2TG</a></li></ul><div class="post__share"></div></div><nav class="post__nav"><div class="post__nav__prev">Previous Post<h5><a href="https://zzsblog.top/pytorch-detect-nan.html" class="inverse" rel="prev">Pytorch 如何定位 NaN？</a></h5></div><div class="post__nav__next">Next Post<h5><a href="https://zzsblog.top/parsing-irregular-json.html" class="inverse" rel="next">Python 如何解析不规则 JSON？</a></h5></div></nav></footer></article></main><footer class="footer"><div class="footer__copyright">Powered by Publii</div></footer></div><script defer="defer" src="https://zzsblog.top/assets/js/scripts.min.js?v=620157e86bfc246cfef480b1b4aadb48"></script><script>window.publiiThemeMenuConfig={mobileMenuMode:'sidebar',animationSpeed:300,submenuWidth: 'auto',doubleClickTime:500,mobileMenuExpandableSubmenus:true,relatedContainerForOverlayMenuSelector:'.navbar'};</script><script>/*<![CDATA[*/var images=document.querySelectorAll("img[loading]");for(var i=0;i<images.length;i++){if(images[i].complete){images[i].classList.add("is-loaded")}else{images[i].addEventListener("load",function(){this.classList.add("is-loaded")},false)}};/*]]>*/</script></body></html>